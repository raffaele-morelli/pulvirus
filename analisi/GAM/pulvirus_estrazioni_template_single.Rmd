---
subtitle: Lorem ipsum dolor sit amet, consectetur adipiscing elit.
subject: Lorem ipsum dolor sit amet, consectetur adipiscing elit.
author: "GAM squad"
date: "`r format(Sys.time(), '%d %B %Y')`"
documentclass: article
link-citations: yes
citecolor: blue
linkcolor: blue
fontsize: 11pt
geometry: margin=1in
lang: it
output:
  html_document:
    toc: yes
    toc_depth: 2
    toc_float: yes
params:
  rdatafile: ~/R/pulvirus/analisi/GAM/output/12/no2/no2_12_IT0825A.RData
  titolo: TEST
header-includes:
- \usepackage{titling}
- \usepackage{hyperref}
- \usepackage{pdflscape}
- \usepackage{graphicx}
- \usepackage{float}
- \usepackage{subfig}
---

---
title: `r params$titolo`
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE, fig.align = 'center')

check.ra <- function (obj, type = c("auto", "deviance", "pearson", "response", 
    "tunif", "tnormal"), k.sample = 5000, k.rep = 200, maxpo = 10000, 
    a.qq = list(), a.hist = list(), a.respoi = list(), ...) 
{
    if (!inherits(obj, "gamViz")) {
        stop("Argument 'obj' should be of class 'gamViz'. See ?getViz")
    }
    if (inherits(obj, "qgam")) {
        return(check.qgam(obj))
    }
    type <- match.arg(type)
    if (type == "auto") {
        type <- .getResTypeAndMethod(obj$family$family)$type
    }
    a.all <- .argMaster("check.gamViz")
    for (nam in names(a.all)) {
        assign(nam, .argSetup(a.all[[nam]], get(nam), nam, verbose = FALSE), 
            envir = environment())
    }
    resid <- residuals(obj, type = type)
    nres <- length(resid)
    subS <- if (nres > maxpo) {
        sample(c(rep(T, maxpo), rep(F, nres - maxpo)))
    }
    else {
        rep(T, nres)
    }
    linpred <- if (is.matrix(obj$linear.predictors) && !is.matrix(resid)) {
        napredict(obj$na.action, obj$linear.predictors[, 1])
    }
    else {
        napredict(obj$na.action, obj$linear.predictors)
    }
    fv <- if (inherits(obj$family, "extended.family")) {
        predict(obj, type = "response")
    }
    else {
        fitted(obj)
    }
    if (is.matrix(fv) && !is.matrix(obj$y)) {
        fv <- fv[, 1]
    }
    resp <- napredict(obj$na.action, obj$y)
    df <- data.frame(linpred = linpred, resid = resid, response = resp, 
        fv = fv)
    dfS <- df[subS, ]

    plots <- list()
    plots[[1]] <- do.call("qq.gamViz", c(list(o = obj), a.qq))$ggObj
    plots[[2]] <- ggplot(data = dfS, aes(x = linpred, y = resid)) + 
        do.call("geom_point", a.respoi) + labs(title = "Resids vs. linear pred.", 
        x = "linear predictor", y = "residuals")
    plots[[3]] <- ggplot(data = df, mapping = aes(x = resid)) + 
        do.call("geom_histogram", a.hist) + labs(title = "Histogram of residuals", 
        xlab = "Residuals")
    plots[[4]] <- ggplot(data = dfS, aes(x = fv, y = response)) + 
        do.call("geom_point", a.respoi) + labs(title = "Response vs. Fitted Values", 
        x = "Fitted Values", y = "Response")

    class(plots) <- "checkGam"
    return(plots)
}

theme_pulvirus <- function() {
  theme_minimal() %+replace% 
    
  theme(plot.title = element_text(size = 10, family = "Tahoma", face = "bold"),
        text = element_text(size = 10, family = "Tahoma"), legend.position = "top",
        axis.title = element_text(face = "bold"),
        axis.text.x = element_text(size = 10),
        panel.background = element_rect(fill = "white",colour = "white", size = 0.5, linetype = "solid"),
        ##panel.grid.major = element_line(size = 0.5, linetype = 'dashed',colour = "#708090"), 
        ##panel.grid.minor = element_line(size = 0.25, linetype = 'dashed', colour = "#708090"),
        axis.line = element_line(colour = "darkblue", 
                                 size = 0.5, linetype = "solid"))
}


library(dplyr)
library(purrr)
library(magrittr)
library(mgcv)
library(logr)
library(knitr)
library(kableExtra)
library(stringr)
library(glue)
library(DT)
library(ggplot2)
library(datiInquinanti)
library(mgcViz)
# basedir <- "~/R/pulvirus"

load(params$rdatafile)

basedir <- "~/R/pulvirus"

```

# Modello

```{r, echo=FALSE, results='asis'}
cat(names(models))
```

# AICS 

```{r, echo=FALSE}
aics <- models %>% 
  map(~ map_dbl(.x, AIC)) %>%  
  do.call(cbind, .) %>% 
  as.data.frame() %>% 
  set_colnames(c('AIC')) %>% 
  round(2) 

# ggplot(aics) + 
#   geom_col(aes(x = rownames(aics), y = AIC), fill = 'dodgerblue')  +  
#   theme(axis.text.x = element_text(angle = 90)) + 
#   xlab("") + 
#   theme_pulvirus()

datatable(aics)
```

# R squared 

```{r, echo=FALSE}
rsquared <- models[[1]] %>%
  map(summary.gam) %>%
  map_dbl(~.$r.sq) %>% 
  as.data.frame() %>% 
  set_colnames(c('R')) %>% 
  round(3) 

# ggplot(rsquared) + 
#   geom_col(aes(x = rownames(rsquared), y = R), fill = 'red')  +  
#   theme(axis.text.x = element_text(angle = 90)) + 
#   xlab("") + 
#   theme_pulvirus()

datatable(rsquared)
```

# P-values

```{r, results='markup', echo=FALSE}
j <- 1
for (i in 1:length( models[[1]] ) ) {
  cat("\n\n## ", names(models[[1]][j]), "\n\n")
  
  b <- mgcv:::anova.gam(models[[1]][[j]]) 
  b$s.table %>%
    kable(format = "pipe", digits = 3) %>%
    print()
  
  cat("\n\n")
  type <- "deviance"  ## "pearson" & "response" are other valid choices
  resid <- residuals(b, type = type)
  linpred <- napredict(b$na.action, b$linear.predictors)
  observed.y <- napredict(b$na.action, b$y)
  
  # grafici
  # qq.gam(b, rep = 0, level = 0.9, type = type, rl.col = 2, rep.col = "gray80")
  
  bv <- getViz(models[[1]][[j]])
  # qq(bv, method = "simul1", a.qqpoi = list(shape=19, size = 0.5), a.ablin = list("linetype" = 2)) + theme_pulvirus()
  
  # b.df <- data.frame("linpred" = linpred, "resid" = resid)
  # ggplot(b.df, aes(x = linpred, y = resid)) + 
    # geom_point() + xlab("Linear pred.") + ylab("Resids") + 
    # theme_pulvirus()
  
  check.ra(bv, type = "deviance",
      a.qq = list(method = "tnorm", a.cipoly = list(fill = "light blue")),
      a.respoi = list(size = 0.5),
      a.hist = list(bins = 25)) %>% print()
  cat("\n\n\n")

  j <- j + 1
}
```

 